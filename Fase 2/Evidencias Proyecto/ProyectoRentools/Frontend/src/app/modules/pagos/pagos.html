<div class="container-pagos">

  <h2 class="titulo">Listado de Pagos</h2>

  <!-- FORMULARIO DE FILTROS -->
  <form [formGroup]="filtrosForm" (ngSubmit)="aplicarFiltros()" class="filtros-card">
    <div class="fila">
      <div class="campo">
        <label>ID Contrato</label>
        <input type="number" formControlName="id_contrato" placeholder="Ej: 1023" />
      </div>

      <div class="campo">
        <label>Método de Pago</label>
        <select formControlName="metodo_pago">
          <option value="">Todos</option>
          <option *ngFor="let m of metodosPago" [value]="m">{{ m }}</option>
        </select>
      </div>

      <div class="campo">
        <label>Fecha Desde</label>
        <input type="date" formControlName="fecha_desde" />
      </div>

      <div class="campo">
        <label>Fecha Hasta</label>
        <input type="date" formControlName="fecha_hasta" />
      </div>
    </div>

    <div class="botones-filtros">
      <button type="submit" class="btn-primary">Aplicar</button>
      <button type="button" class="btn-secondary" (click)="limpiarFiltros()">Limpiar</button>
    </div>
  </form>

  <!-- SPINNER DE CARGA -->
  <div class="loader" *ngIf="loading"></div>

  <!-- TABLA DE PAGOS -->
  <table *ngIf="!loading" class="table table-striped table-pagos">
    <thead>
      <tr class="table-header-title">
        <th colspan="7">Pagos registrados</th>
      </tr>

      <tr class="table-header-columns">
        <th>ID</th>
        <th>Contrato</th>
        <th>Método pago</th>
        <th>Monto Pagado</th>
        <th>Fecha pago</th>
        <th>Referencia</th>
        <th>Acciones</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let p of pagos">
        <td>{{ p.id_pago }}</td>
        <td>{{ p.id_contrato }}</td>
        <td>{{ p.metodo_pago }}</td>
        <td>${{ p.monto | number:'1.0-0' }}</td>
        <td>{{ p.fecha_pago }}</td>
        <td>{{p.referencia}}</td>
        <td class="acciones text-center">
          <!-- Ver detalle -->
          <button class="btn btn-sm btn-outline-primary me-1" title="Ver detalle" (click)="abrirDetallePago(p.id_pago)">
            <i class="bi bi-eye"></i>
          </button>

          <!-- Editar referencia -->
          <button class="btn btn-sm btn-outline-warning me-1" title="Editar referencia"
            (click)="abrirEditarReferencia(p.id_pago, p.referencia)">
            <i class="bi bi-pencil-square"></i>
          </button>

          <!-- Eliminar -->
          <button class="btn btn-sm btn-outline-danger" title="Eliminar pago" (click)="eliminarPago(p.id_pago)">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- PAGINACIÓN -->
  <div class="paginacion" *ngIf="!loading && pagos.length > 0">
    <button (click)="paginaAnterior()" [disabled]="page === 1">Anterior</button>
    <span>Página {{ page }}</span>
    <button (click)="siguientePagina()" [disabled]="page * limit >= totalPagos">Siguiente</button>
  </div>

</div>

<!-- Modal Ver Detalle -->
<div class="modal" *ngIf="modalDetalleAbierto">
  <div class="modal-content">
    <span class="close" (click)="cerrarModalDetalle()">&times;</span>
    <h3>Detalle del Pago</h3>
    <p><strong>ID Pago:</strong> {{ pagoDetalle?.id_pago }}</p>
    <p><strong>ID Contrato:</strong> {{ pagoDetalle?.id_contrato }}</p>
    <p><strong>Monto:</strong> ${{ pagoDetalle?.monto }}</p>
    <p><strong>Fecha Pago:</strong> {{ pagoDetalle?.fecha_pago | date:'dd/MM/yyyy' }}</p>
    <p><strong>Método:</strong> {{ pagoDetalle?.metodo_pago }}</p>
    <p><strong>Referencia:</strong> {{ pagoDetalle?.referencia || '-' }}</p>
    <p><strong>Contrato Fecha Inicio:</strong> {{ pagoDetalle?.contrato?.fecha_inicio }}</p>
    <p><strong>Contrato Fecha Termino:</strong> {{ pagoDetalle?.contrato?.fecha_termino_real }}</p>
    <p><strong>Monto Final Contrato:</strong> ${{ pagoDetalle?.contrato?.monto_final }}</p>
    <!-- más info si quieres -->
  </div>
</div>

<!-- Modal Editar Referencia -->
<!-- Modal de edición -->
<div class="modal" *ngIf="modalEditarAbierto">
  <div class="modal-overlay" (click)="cerrarModalEditar()"></div>

  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="bi bi-pencil-square me-1"></i> Editar Referencia</h3>
      <button class="close-btn" (click)="cerrarModalEditar()">&times;</button>
    </div>

    <form [formGroup]="editarReferenciaForm" (ngSubmit)="guardarReferencia()">
      <div class="modal-body">
        <label for="referencia">Referencia</label>
        <input id="referencia" formControlName="referencia" placeholder="Ingresa nueva referencia" />
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalEditar()">Cancelar</button>
        <button type="submit" class="btn btn-warning" [disabled]="editarReferenciaForm.invalid">
          <i class="bi bi-check-circle me-1"></i> Guardar
        </button>
      </div>
    </form>
  </div>
</div>